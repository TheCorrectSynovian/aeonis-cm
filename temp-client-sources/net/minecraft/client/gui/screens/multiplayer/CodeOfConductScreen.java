package net.minecraft.client.gui.screens.multiplayer;

import it.unimi.dsi.fastutil.booleans.BooleanConsumer;
import net.fabricmc.api.EnvType;
import net.fabricmc.api.Environment;
import net.minecraft.ChatFormatting;
import net.minecraft.client.gui.components.Button;
import net.minecraft.client.gui.layouts.Layout;
import net.minecraft.client.gui.layouts.LinearLayout;
import net.minecraft.client.gui.screens.ConnectScreen;
import net.minecraft.client.gui.screens.Screen;
import net.minecraft.client.multiplayer.ServerData;
import net.minecraft.client.multiplayer.ServerList;
import net.minecraft.network.chat.CommonComponents;
import net.minecraft.network.chat.Component;
import org.jspecify.annotations.Nullable;

@Environment(EnvType.CLIENT)
public class CodeOfConductScreen extends WarningScreen {
	private static final Component TITLE = Component.translatable("multiplayer.codeOfConduct.title").withStyle(ChatFormatting.BOLD);
	private static final Component CHECK = Component.translatable("multiplayer.codeOfConduct.check");
	@Nullable
	private final ServerData serverData;
	private final String codeOfConductText;
	private final BooleanConsumer resultConsumer;
	private final Screen parent;

	private CodeOfConductScreen(@Nullable ServerData serverData, Screen screen, Component component, String string, BooleanConsumer booleanConsumer) {
		super(TITLE, component, CHECK, TITLE.copy().append("\n").append(component));
		this.serverData = serverData;
		this.parent = screen;
		this.codeOfConductText = string;
		this.resultConsumer = booleanConsumer;
	}

	public CodeOfConductScreen(@Nullable ServerData serverData, Screen screen, String string, BooleanConsumer booleanConsumer) {
		this(serverData, screen, Component.literal(string), string, booleanConsumer);
	}

	@Override
	protected Layout addFooterButtons() {
		LinearLayout linearLayout = LinearLayout.horizontal().spacing(8);
		linearLayout.addChild(Button.builder(CommonComponents.GUI_ACKNOWLEDGE, button -> this.onResult(true)).build());
		linearLayout.addChild(Button.builder(CommonComponents.GUI_DISCONNECT, button -> this.onResult(false)).build());
		return linearLayout;
	}

	private void onResult(boolean bl) {
		this.resultConsumer.accept(bl);
		if (this.serverData != null) {
			if (bl && this.stopShowing.selected()) {
				this.serverData.acceptCodeOfConduct(this.codeOfConductText);
			} else {
				this.serverData.clearCodeOfConduct();
			}

			ServerList.saveSingleServer(this.serverData);
		}
	}

	@Override
	public boolean shouldCloseOnEsc() {
		return false;
	}

	@Override
	public void tick() {
		super.tick();
		if (this.parent instanceof ConnectScreen || this.parent instanceof ServerReconfigScreen) {
			this.parent.tick();
		}
	}
}
